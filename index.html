<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiplayer Golf Scorecard â€“ Regular (Firestore Realtime)</title>
  <style>
    :root{--c:#0b6bfd;--bg:#0b1020;--card:#0f1426;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--purple:#7c3aed}
    html,body{margin:0;height:100%;background:var(--bg);color:#e5e7eb;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:18px;margin:0 0 6px;color:#cbd5e1}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>input,.row>button,.row>select,.row>textarea{padding:8px 10px;border-radius:10px;border:1px solid #334155;background:#0b1020;color:#e5e7eb}
    .row>button{background:var(--c);border-color:transparent;cursor:pointer}
    .row>button.ghost{background:#0b1020;border:1px dashed #334155}
    .help{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1020;border:1px solid #334155;color:#cbd5e1}
    .muted{color:#94a3b8}
    .hidden{display:none}
    .right{margin-left:auto}
    .status{display:inline-flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.live{background:#22c55e;box-shadow:0 0 0 6px rgba(34,197,94,.15)}
    .dot.off{background:#64748b}

    /* Verticale scorekaart */
    .vtable{display:grid;gap:6px;overflow:auto}
    .vcol{display:flex;flex-direction:column;gap:6px;min-width:90px}
    .vhead{font-weight:700;text-align:center}
    .cell{background:#0c1226;border:1px solid #1f2937;border-radius:10px;padding:8px;text-align:center;max-width:25ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .cell input{width:100%;text-align:center;border:1px solid #334155;background:#0a1220;color:#ffffff;border-radius:8px;padding:10px;font-size:16px}
    .parcol .cell{background:#0a1020}
    .hcpcell input{width:64px}

    .badge{border-radius:8px;padding:2px 6px;font-size:12px;display:inline-block}
    .birdie{background:#05243a;border:1px solid #1b4d6b;color:#9bd3ff}
    .eagle{background:#052a1b;border:1px solid #1f6b3a;color:#9bffbc}
    .par{background:#1f2937;color:#cbd5e1}
    .bogey{background:var(--purple);color:white}

    .switch{display:inline-flex;gap:8px;align-items:center}

    /* Confetti */
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .piece{position:absolute;will-change:transform;animation:fall 5s ease-out forwards}
    @keyframes fall{to{transform:translate(var(--dx), 100vh) rotate(1080deg);opacity:0}}

    /* Overlay voor file:// */
    .overlay{position:fixed;inset:0;background:#0b1020;z-index:9999;display:none;padding:18px}
    .overlay .box{max-width:900px;margin:0 auto;background:#0f1426;border:1px solid #1f2937;border-radius:14px;padding:16px}
    .overlay h2{margin:0 0 8px}
    .httpok .overlay{display:none}
  </style>
  <script>if(location.protocol==='http:'||location.protocol==='https:'){document.documentElement.classList.add('httpok');}else{document.addEventListener('DOMContentLoaded',()=>{document.getElementById('fileOverlay').style.display='block';});}</script>
</head>
<body>
  <div class="overlay" id="fileOverlay">
    <div class="box">
      <h2>Open via localhost / GitHub Pages (niet file://)</h2>
      <p class="help">Start lokaal: <code>python -m http.server 8000</code> â†’ ga naar <code>http://localhost:8000/</code>. Of host via GitHub Pages.</p>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

  <div class="wrap">
    <div class="card" id="authCard">
      <h1>Multiplayer Golf Scorecard</h1>
      <div class="row">
        <input id="displayName" type="text" placeholder="Jouw naam" />
        <button id="btnLogin">Inloggen (anoniem)</button>
      </div>
      <p class="help">Simpel inloggen (anoniem). Je naam is zichtbaar in de scorelijst. Geen wachtwoord nodig.</p>
      <p id="authInfo" class="help"></p>
    </div>

    <div class="card hidden" id="lobbyCard">
      <h2>Nieuwe ronde</h2>
      <div class="row">
        <label>Scorecard type:
          <select id="modeSelect">
            <option value="regular" selected>Regular (pars + handicaps)</option>
            <option value="extended" disabled>Extended (binnenkort)</option>
          </select>
        </label>
        <label>Aantal holes:
          <select id="holesSelect">
            <option value="9">9 holes (1â€“9)</option>
            <option value="18" selected>18 holes</option>
          </select>
        </label>
        <button id="btnCreate">Maak nieuwe game</button>
      </div>
      <h2>Of meespelen</h2>
      <div class="row">
        <input id="gameCode" type="text" placeholder="Game code (bv. 6-8 tekens)" />
        <button id="btnJoin" class="ghost">Join bestaande game</button>
        <span class="pill" id="mePill">Niet ingelogd</span>
      </div>
    </div>

    <div class="card hidden" id="gameCard">
      <div class="row">
        <h2 class="right">Game: <span id="codeOut" class="pill"></span> <span id="modeOut" class="pill"></span> <span id="holesOut" class="pill"></span></h2>
      </div>

      <div class="row">
        <label>Course: <input id="courseName" type="text" placeholder="Baan naam" /></label>
        <label>Datum: <input id="gameDate" type="date" /></label>
        <label>Teetime: <input id="teeTime" type="time" /></label>
        <span class="status"><span class="dot off" id="liveDot"></span> <span id="liveTxt">Offline</span></span>
        <span class="pill" id="rolePill">rol: speler</span>
        <label class="switch"><input type="checkbox" id="toggleBack" checked> Toon holes 10â€“18</label>
      </div>

      <div class="row">
        <button id="btnAddMe">Voeg mij toe als speler</button>
        <label>Mijn flight:
          <select id="flightSelect">
            <option value="A" selected>A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </label>
        <div id="hostAdd" class="row" style="gap:6px;display:none">
          <input id="manualName" type="text" placeholder="Spelernaam" />
          <input id="manualHcp" type="number" min="0" max="54" value="0" />
          <label>Flight:
            <select id="manualFlight">
              <option value="A" selected>A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </label>
          <button id="btnAddManual" class="ghost">Host: speler handmatig toevoegen</button>
        </div>
        <button id="btnCopyLink" class="ghost">Kopieer invite link</button>
      </div>

      <div class="card">
        <div id="vtableFront" class="vtable" style="grid-template-columns: repeat(1, minmax(90px,1fr));"></div>
        <div id="vtableBackWrap" class="hidden">
          <div style="height:8px"></div>
          <div id="vtableBack" class="vtable" style="grid-template-columns: repeat(1, minmax(90px,1fr));"></div>
        </div>
      </div>

      <div class="card">
        <h2>Leaderboard</h2>
        <div id="leader"></div>
      </div>

      <div class="card">
        <h2>Export</h2>
        <div class="row">
          <button id="btnExport" class="ghost">Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, updateDoc, serverTimestamp, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYzZ02RvPTDHLUu9Eh6sJXJ-gZNrrHiVY",
      authDomain: "multiplayer-golf-scorecard.firebaseapp.com",
      projectId: "multiplayer-golf-scorecard",
      storageBucket: "multiplayer-golf-scorecard.appspot.com",
      messagingSenderId: "824350863208",
      appId: "1:824350863208:web:c0455cafc028ec9bfa70dd",
      measurementId: "G-MT45DZXMR2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // DOM helpers
    const $ = (q)=>document.querySelector(q);
    const el = (t, a={})=>{ const e=document.createElement(t); Object.assign(e,a); return e };

    // Elements
    const authCard = $('#authCard');
    const lobbyCard= $('#lobbyCard');
    const gameCard = $('#gameCard');

    const displayName = $('#displayName');
    const btnLogin    = $('#btnLogin');
    const authInfo    = $('#authInfo');

    const btnCreate   = $('#btnCreate');
    const gameCodeInp = $('#gameCode');
    const btnJoin     = $('#btnJoin');
    const mePill      = $('#mePill');
    const modeSelect  = $('#modeSelect');
    const holesSelect = $('#holesSelect');

    const courseName  = $('#courseName');
    const gameDate    = $('#gameDate');
    const teeTime     = $('#teeTime');
    const liveDot     = $('#liveDot');
    const liveTxt     = $('#liveTxt');
    const rolePill    = $('#rolePill');
    const toggleBack  = $('#toggleBack');

    const vtableFront = $('#vtableFront');
    const vtableBack  = $('#vtableBack');
    const vtableBackWrap = $('#vtableBackWrap');

    const leader      = $('#leader');
    const btnAddMe    = $('#btnAddMe');
    const btnAddManual= $('#btnAddManual');
    const manualName  = $('#manualName');
    const manualHcp   = $('#manualHcp');
    const flightSelect= $('#flightSelect');
    const manualFlight= $('#manualFlight');
    const btnCopyLink = $('#btnCopyLink');
    const btnExport   = $('#btnExport');
    const codeOut     = $('#codeOut');
    const modeOut     = $('#modeOut');
    const holesOut    = $('#holesOut');

    const confettiBox = $('#confetti');

    // State
    let currentUser = null;
    let currentGameId = null;
    let unsubPlayers = null;
    let unsubGame = null;
    let unsubEvents = null;
    let hostUid = null;
    let openInput = false;
    let par = new Array(18).fill(4);
    let mode = 'regular';
    let holes = 18; // 9 of 18
    let players = [];

    // Restore
    gameCodeInp.value = localStorage.getItem('golf_game') || '';
    displayName.value = localStorage.getItem('golf_name') || '';

    // Auth
    btnLogin.addEventListener('click', async ()=>{
      const name = displayName.value.trim() || 'Speler';
      await signInAnonymously(auth);
      onAuthStateChanged(auth, async (u)=>{
        if(u && (!u.displayName || u.displayName!==name)){
          try{ await updateProfile(u,{displayName:name}); }catch(e){console.warn(e)}
        }
      })
    });

    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      if(user){
        authInfo.textContent = `Ingelogd als ${user.displayName||'Speler'} (uid ${user.uid.slice(0,6)}â€¦)`;
        mePill.textContent = `Ingelogd: ${user.displayName||'Speler'}`;
        authCard.classList.add('hidden');
        lobbyCard.classList.remove('hidden');
        localStorage.setItem('golf_name', user.displayName||'Speler');
      } else {
        authCard.classList.remove('hidden');
        lobbyCard.classList.add('hidden');
        gameCard.classList.add('hidden');
      }
    });

    // Game lifecycle
    function randCode(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }

    btnCreate.addEventListener('click', async ()=>{
      const code = randCode();
      const gameRef = doc(db,'games',code);
      const today = new Date().toISOString().slice(0,10);
      const ttime = teeTime.value || '';
      mode = modeSelect.value;
      holes = parseInt(holesSelect.value,10);
      await setDoc(gameRef,{
        code,
        createdAt: serverTimestamp(),
        hostUid: currentUser.uid,
        openInput: false,
        mode: 'regular',
        settings: { holes },
        course: { name: 'Onbekende baan', date: today, teetime: ttime, par: new Array(18).fill(4) }
      });
      await joinGame(code);
    });

    btnJoin.addEventListener('click', async ()=>{
      const code = gameCodeInp.value.trim().toUpperCase();
      if(!code) return alert('Vul een game code in.');
      await joinGame(code);
    });

    async function joinGame(code){
      currentGameId = code;
      codeOut.textContent = code;
      localStorage.setItem('golf_game', code);
      lobbyCard.classList.add('hidden');
      gameCard.classList.remove('hidden');
      startListeners();
    }

    function holeIndices(){ return holes===9 ? [...Array(9).keys()] : [...Array(18).keys()]; }

    async function startListeners(){
      if(unsubPlayers) unsubPlayers();
      if(unsubGame) unsubGame();
      if(unsubEvents) unsubEvents();

      const gameRef = doc(db,'games',currentGameId);

      unsubGame = onSnapshot(gameRef, (snap)=>{
        if(!snap.exists()) return;
        const g = snap.data();
        hostUid = g.hostUid;
        openInput = !!g.openInput;
        par = g.course?.par || new Array(18).fill(4);
        mode = g.mode || 'regular';
        holes = g.settings?.holes || 18;
        courseName.value = g.course?.name || '';
        gameDate.value = g.course?.date || '';
        teeTime.value = g.course?.teetime || '';
        toggleBack.checked = true;
        vtableBackWrap.classList.toggle('hidden', holes===9 || !toggleBack.checked);
        holesOut.textContent = `${holes} holes`;
        modeOut.textContent = `mode: ${mode}`;

        const isHost = currentUser && currentUser.uid===hostUid;
        rolePill.textContent = `rol: ${isHost?'host':'speler'}`;
        document.getElementById('hostAdd').style.display = isHost?'flex':'none';
        renderVertical();
        setLive(true);
      });

      const qPlayers = query(collection(db,'games',currentGameId,'players'), orderBy('total'));
      unsubPlayers = onSnapshot(qPlayers, (qs)=>{
        players = [];
        qs.forEach(d=>players.push({id:d.id, ...d.data()}));
        renderVertical();
        renderLeader(players);
        maybeFinalEvent(players);
      });
        renderVertical();
        renderLeader(players);
        maybeFinalEvent(players);
      });

      unsubEvents = onSnapshot(collection(db,'games',currentGameId,'events'), (qs)=>{
        qs.docChanges().forEach(ch=>{ if(ch.type==='added') handleEvent(ch.doc.data()); })
      })

      toggleBack.addEventListener('change', ()=>{ vtableBackWrap.classList.toggle('hidden', holes===9 || !toggleBack.checked); });

      courseName.addEventListener('change', debounce(async ()=>{ if(!isHost()) return; await updateDoc(gameRef,{ 'course.name': courseName.value }); }, 300));
      gameDate.addEventListener('change', debounce(async ()=>{ if(!isHost()) return; await updateDoc(gameRef,{ 'course.date': gameDate.value }); }, 0));
      teeTime.addEventListener('change', debounce(async ()=>{ if(!isHost()) return; await updateDoc(gameRef,{ 'course.teetime': teeTime.value }); }, 0));

      btnAddMe.onclick = addMeAsPlayer;
      btnAddManual.onclick = addManualPlayer;
      btnCopyLink.onclick = copyInvite;
      btnExport.onclick = exportJson;
    }

    function isHost(){ return currentUser && currentUser.uid===hostUid }
    function setLive(on){ liveDot.classList.toggle('live',on); liveDot.classList.toggle('off',!on); liveTxt.textContent = on?'Live':'Offline'; }

    async function addMeAsPlayer(){
      if(!currentUser) return;
      const pRef = doc(db,'games',currentGameId,'players', currentUser.uid);
      const name = (currentUser.displayName||'Speler').trim();
      const init = new Array(18).fill(null);
      const flight = flightSelect?.value || 'A';
      await setDoc(pRef,{ uid: currentUser.uid, name, flight, handicap: 0, strokes: init, total: 0, updatedAt: serverTimestamp() }, {merge:true});
    }

    async function addManualPlayer(){
      if(!isHost()) return alert('Alleen host');
      const name = (manualName.value||'Speler').trim();
      const hcp  = clamp(int(manualHcp.value,0),0,54);
      const flight = manualFlight?.value || 'A';
      const id = 'm_'+Math.random().toString(36).slice(2,8);
      const pRef = doc(db,'games',currentGameId,'players', id);
      await setDoc(pRef,{ uid: id, name, flight, handicap: hcp, strokes: new Array(18).fill(null), total:0, updatedAt: serverTimestamp() });
      manualName.value=''; manualHcp.value='0';
    }

    function renderVertical(){
      // Build columns: Hole numbers, Par, then each player
      const colsF = [buildHoleColumn(0,9), buildParColumn(0,9), ...players.map(p=>buildPlayerColumn(p,0,9))];
      vtableFront.innerHTML='';
      vtableFront.style.gridTemplateColumns = `repeat(${colsF.length}, minmax(110px,1fr))`;
      colsF.forEach(c=>vtableFront.append(c));

      const showBack = holes===18 && toggleBack.checked;
      if(showBack){
        const colsB = [buildHoleColumn(9,18), buildParColumn(9,18), ...players.map(p=>buildPlayerColumn(p,9,18))];
        vtableBack.innerHTML='';
        vtableBack.style.gridTemplateColumns = `repeat(${colsB.length}, minmax(110px,1fr))`;
        colsB.forEach(c=>vtableBack.append(c));
        vtableBackWrap.classList.remove('hidden');
      } else {
        vtableBackWrap.classList.add('hidden');
      }
    }

    function buildHoleColumn(start,end){
      const col = el('div',{className:'vcol'});
      col.append(el('div',{className:'cell vhead', innerHTML:`Hole<br><span class='muted'>${start+1}-${end}</span>`}));
      for(let i=start;i<end;i++){
        col.append(el('div',{className:'cell', innerText: `H${i+1}`}));
      }
      col.append(el('div',{className:'cell vhead', innerHTML:`â€”`}));
      return col;
    }

    function buildParColumn(start,end){
      const col = el('div',{className:'vcol parcol'});
      col.append(el('div',{className:'cell vhead', innerHTML:`Par<br><span class='muted'>${start+1}-${end}</span>`}));
      for(let i=start;i<end;i++){
        const inp = el('input',{type:'number', min:2, max:7, value: par[i]||4});
        inp.onchange = debounce(async ()=>{ par[i]=clamp(int(inp.value,4),2,7); await updateDoc(doc(db,'games',currentGameId), { 'course.par': par }); renderVertical(); renderLeader(players); }, 200);
        const cell = el('div',{className:'cell'}); cell.append(inp); col.append(cell);
      }
      const idx = [...Array(end-start).keys()].map(k=>start+k);
      const parSum = idx.reduce((s,i)=>s+(par[i]||0),0);
      col.append(el('div',{className:'cell vhead', innerHTML:`Par totaal<br><b>${parSum}</b>`}));
      return col;
    }

    function buildPlayerColumn(p,start,end){
      const editable = (openInput || p.uid===auth.currentUser?.uid || isHost());
      const col = el('div',{className:'vcol'});
      const flightBadge = p.flight? `<span class="pill" style="font-size:11px">Flt ${p.flight}</span>`:'';

      // Header met naam + HCP input + acties (geen extra rij â†’ lijnen blijven gelijk)
      const head = el('div',{className:'cell vhead'});
      const nameSpan = el('span',{innerHTML: `${escapeHtml(p.name)} ${flightBadge}`});
      head.append(nameSpan);
      // HCP inline
      const hcpWrap = el('div',{style:'margin-top:6px; display:flex; gap:6px; align-items:center; justify-content:center'});
      hcpWrap.append(el('span',{className:'muted', innerText:'HCP'}));
      const hcpInp = el('input',{type:'number', min:0, max:54, value: p.handicap ?? 0, style:'max-width:70px'});
      hcpInp.disabled=!editable; hcpInp.onchange = debounce(()=> saveHandicap(p.uid, hcpInp.value), 200);
      hcpWrap.append(hcpInp);
      // Actieknoppen voor host (rename/flight/delete)
      if(isHost()){
        const btns = el('div',{style:'display:flex; gap:6px; margin-top:6px; justify-content:center'});
        const bEdit = el('button',{innerText:'âœŽ', title:'Naam bewerken', className:'pill'});
        const bFlight = el('button',{innerText:'â‡„', title:'Flight wijzigen', className:'pill'});
        const bDel = el('button',{innerText:'ðŸ—‘', title:'Speler verwijderen', className:'pill'});
        bEdit.onclick = ()=> renamePlayer(p.uid, p.name);
        bFlight.onclick = ()=> changeFlight(p.uid, p.flight||'A');
        bDel.onclick = ()=> deletePlayer(p.uid);
        btns.append(bEdit,bFlight,bDel);
        head.append(btns);
      }
      head.append(hcpWrap);
      col.append(head);

      const strokes = (p.strokes||new Array(18).fill(null)).slice(0,18);
      for(let i=start;i<end;i++){
        const cell = el('div',{className:'cell'});
        const inp = el('input',{type:'number', min:1, max:8, value: strokes[i] ?? ''});
        inp.disabled = !editable;
        inp.onchange = debounce(()=> saveStroke(p.uid, i, inp.value), 120);
        if(strokes[i]!=null){ colorCodeCell(cell, strokes[i], par[i]); }
        cell.append(inp);
        col.append(cell);
      }

      // Totals for this segment
      const idx = [...Array(end-start).keys()].map(k=>start+k);
      const gross = idx.reduce((s,i)=>s+(int(strokes[i],0)||0),0);
      const parSum = idx.reduce((s,i)=>s+(par[i]||0),0);
      const totalCell = el('div',{className:'cell vhead'});
      totalCell.innerHTML = `Totaal<br><b>${gross}</b> â€¢ <span class='muted'>Â±Par ${signed(gross-parSum)}</span>`;
      col.append(totalCell);
      return col;
    }

    function colorCodeCell(cell, strokes, p){(cell, strokes, p){
      const diff = strokes - p;
      let cls='par', label='Par';
      if(diff<=-2){ cls='eagle'; label='Eagle'; }
      else if(diff===-1){ cls='birdie'; label='Birdie'; }
      else if(diff>=1){ cls='bogey'; label='Bogey+'; }
      const b = el('span',{className:`badge ${cls}`, innerText:label});
      cell.append(el('div',{style:'margin-top:6px'}));
      cell.append(b);
    }

    async function saveHandicap(playerUid, value){
      const v = clamp(int(value,0), 0, 54);
      const pRef = doc(db,'games',currentGameId,'players', playerUid);
      await setDoc(pRef, { handicap: v, updatedAt: serverTimestamp() }, {merge:true});
    }

    async function saveStroke(playerUid, holeIndex, value){
      let v = clamp(int(value,null), 1, 8); // max 8
      const pRef = doc(db,'games',currentGameId,'players', playerUid);
      const snap = await getDoc(pRef);
      const data = snap.exists()? snap.data(): {strokes:new Array(18).fill(null)};
      const strokes = (data.strokes||new Array(18).fill(null)).slice(0,18);
      strokes[holeIndex] = v;
      const total = strokes.reduce((a,b)=>a+(b||0),0);
      await setDoc(pRef, { strokes, total, updatedAt: serverTimestamp() }, {merge:true});

      // Update lokale state voor directe feedback
      const idx = players.findIndex(x=>x.uid===playerUid);
      if(idx>=0){ players[idx] = { ...players[idx], strokes, total }; }
      renderVertical();
      renderLeader(players);

      // Awards & events
      const pf = players.find(x=>x.uid===playerUid) || data;
      const pPar = par[holeIndex]||4;
      if(v<=pPar-1){ // birdie/eagle
        const type = (v<=pPar-2)?'eagle':'birdie';
        await addEvent({type, hole: holeIndex+1, player: pf.name||'Speler'});
      }
      maybeFinalEvent(players);
    }

    function maybeFinalEvent(arr){(arr){
      const idx = holeIndices();
      if(arr.length===0) return;
      const allDone = arr.every(p=>{ const s = (p.strokes||[]); return idx.every(i => typeof s[i]==='number' && s[i]>0); });
      if(!allDone) return;
      const parSum = idx.reduce((s,i)=>s+(par[i]||0),0);
      const scored = arr.map(p=>{ const gross = idx.reduce((s,i)=>s+(int((p.strokes||[])[i],0)||0),0); const net = (gross - parSum) - (p.handicap||0) * (idx.length/18); return {name:p.name||'Speler', gross, net}; });
      scored.sort((a,b)=>a.net-b.net);
      const winner = scored[0];
      addEvent({type:'game_end', winner, parSum, holes: idx.length});
    }

    async function addEvent(payload){ try{ await addDoc(collection(db,'games',currentGameId,'events'), { ...payload, at: serverTimestamp() }); }catch(e){} }

    function handleEvent(ev){
      if(ev.type==='birdie'||ev.type==='eagle'){
        celebrate(`${ev.player} â€” ${ev.type.toUpperCase()} op hole ${ev.hole}!`);
      } else if(ev.type==='game_end'){
        celebrate(`WINNAAR: ${ev.winner.name}  (Net: ${Number(ev.winner.net).toFixed(1)})`, true);
      }
    }

    function celebrate(text, big=false){
      launchConfetti(big?600:400);
      const banner = el('div',{style:`position:fixed;inset:auto 0 10%;margin:auto;max-width:90%;text-align:center;font-weight:800;font-size:${big? '46px':'30px'};color:white;text-shadow:0 2px 10px #000`});
      banner.innerText = text;
      document.body.append(banner);
      setTimeout(()=>banner.remove(), 5000);
    }

    function launchConfetti(n=400){
      for(let i=0;i<n;i++){
        const d = el('div',{className:'piece'});
        d.style.left = Math.random()*100+'%';
        d.style.top = '-10px';
        d.style.setProperty('--dx', ((Math.random()*300-150))+'px');
        d.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
        d.style.width = d.style.height = (6+Math.random()*6)+'px';
        confettiBox.append(d);
        setTimeout(()=>d.remove(), 5200);
      }
    }(text, big=false){
      launchConfetti(big?600:400); // veel meer confetti
      // geen geluid meer
      const banner = el('div',{style:`position:fixed;inset:auto 0 10%;margin:auto;max-width:90%;text-align:center;font-weight:800;font-size:${big? '46px':'30px'};color:white;text-shadow:0 2px 10px #000`});
      banner.innerText = text;
      document.body.append(banner);
      setTimeout(()=>banner.remove(), 5000); // 5s
    }

    function launchConfetti(n=400){
      for(let i=0;i<n;i++){
        const d = el('div',{className:'piece'});
        d.style.left = Math.random()*100+'%';
        d.style.top = '-10px';
        d.style.setProperty('--dx', ((Math.random()*300-150))+'px');
        d.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
        d.style.width = d.style.height = (6+Math.random()*6)+'px';
        confettiBox.append(d);
        setTimeout(()=>d.remove(), 5200);
      }
    }

    // (geluid-functies verwijderd)(text, big=false){
      launchConfetti(big?200:120);
      playFanfare(big);
      const banner = el('div',{style:`position:fixed;inset:auto 0 10%;margin:auto;max-width:90%;text-align:center;font-weight:800;font-size:${big? '42px':'28px'};color:white;text-shadow:0 2px 10px #000`});
      banner.innerText = text;
      document.body.append(banner);
      setTimeout(()=>banner.remove(), 3500);
    }

    function launchConfetti(n=120){
      for(let i=0;i<n;i++){
        const d = el('div',{className:'piece'});
        d.style.left = Math.random()*100+'%';
        d.style.top = '-10px';
        d.style.setProperty('--dx', ((Math.random()*200-100))+'px');
        d.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
        d.style.width = d.style.height = (6+Math.random()*6)+'px';
        confettiBox.append(d);
        setTimeout(()=>d.remove(), 2200);
      }
    }

    // Audio (fanfare + applaus) zonder externe assets
    let audioCtx=null; function ac(){ return audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)()); }
    function playFanfare(big=false){
      const ctx = ac();
      const seq = big? [440,523,659,784,880] : [523,659,784];
      let t = ctx.currentTime;
      seq.forEach((f)=>{ const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='square'; o.frequency.value=f; o.connect(g); g.connect(ctx.destination); const dur=0.18; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.2,t+0.02); g.gain.exponentialRampToValueAtTime(0.001,t+dur); o.start(t); o.stop(t+dur); t+=dur*0.9; });
      const noise = ctx.createBufferSource(); const buffer = ctx.createBuffer(1, ctx.sampleRate*0.6, ctx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.3; noise.buffer=buffer; const gn = ctx.createGain(); gn.gain.value= big?0.25:0.15; noise.connect(gn); gn.connect(ctx.destination); noise.start(t);
    }

    async function copyInvite(){ const url = new URL(location.href); url.searchParams.set('game', currentGameId); await navigator.clipboard.writeText(url.toString()); alert('Invite link gekopieerd naar klembord'); }

    async function exportJson(){ const gameRef = doc(db,'games',currentGameId); const gameSnap = await getDoc(gameRef); const playersArr = await fetchPlayersOnce(); const data = { gameId: currentGameId, ...(gameSnap.exists()?gameSnap.data():{}), players: playersArr }; const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a = el('a'); a.href = URL.createObjectURL(blob); a.download = `golf_${currentGameId}.json`; a.click(); }

    function fetchPlayersOnce(){ return new Promise((resolve,reject)=>{ const q = query(collection(db,'games',currentGameId,'players')); const stop = onSnapshot(q, (qs)=>{ const arr=[]; qs.forEach(d=>arr.push({id:d.id, ...d.data()})); stop(); resolve(arr); }, reject); }); }

    function renderLeader(arr){
      leader.innerHTML='';
      const idx = holeIndices();
      const parSum = idx.reduce((s,i)=>s+(par[i]||0),0);
      const scored = arr.map(p=>{
        const gross = idx.reduce((s,i)=>s+(int((p.strokes||[])[i],0)||0),0);
        const net = (gross - parSum) - (p.handicap||0) * (idx.length/18);
        return {name:p.name||'Speler', gross, net};
      }).sort((a,b)=>a.net-b.net);
      const wrap = el('div');
      scored.forEach((r,i)=>{
        const row = el('div',{className:'row', style:'justify-content:space-between'});
        row.append(el('div',{innerText:`${i+1}. ${r.name}`}));
        row.append(el('div',{innerText:`Gross ${r.gross} â€¢ Net ${r.net.toFixed(1)}`}));
        wrap.append(row);
      });
      leader.append(wrap);
    }

    // helpers
    function int(v,def){ const n = parseInt(v,10); return isNaN(n)?def:n }
    function clamp(n,min,max){ if(n==null)return n; return Math.max(min, Math.min(max,n)) }
    function signed(n){ return (n>0?'+':'')+n }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } }
    function escapeHtml(s){ return (s||'').replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])) }

    async function renamePlayer(uid, oldName){
      if(!isHost()) return;
      const name = prompt('Nieuwe naam voor speler:', oldName||'');
      if(!name) return;
      await updateDoc(doc(db,'games',currentGameId,'players', uid), { name: name.trim(), updatedAt: serverTimestamp() });
    }
    async function changeFlight(uid, old){
      if(!isHost()) return;
      const fl = prompt('Flight (A-D):', old||'A');
      if(!fl) return;
      await updateDoc(doc(db,'games',currentGameId,'players', uid), { flight: fl.toUpperCase().slice(0,1), updatedAt: serverTimestamp() });
    }
    async function deletePlayer(uid){
      if(!isHost()) return;
      if(!confirm('Verwijder deze speler?')) return;
      await deleteDoc(doc(db,'games',currentGameId,'players', uid));
    }

    // Auto-join via URL ?game=CODE
    (function(){ const sp = new URLSearchParams(location.search); const g = sp.get('game'); if(g){ gameCodeInp.value = g; } })();
  </script>
</body>
</html>
